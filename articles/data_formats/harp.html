<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Software Events" href="software_events.html" /><link rel="prev" title="Dataset structure" href="../core/dataset_structure.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>Harp - AIND Behavior Services</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">AIND Behavior Services</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/light-logo.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/dark-logo.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">AIND Behavior Services</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to AIND Behavior Services’s documentation!</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.rig.html">rig</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.task_logic.html">task_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.session.html">session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.data_types.html">data_types</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api.calibration.html">calibration</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of calibration</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.calibration/aind_manipulator.html">aind_manipulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.calibration/load_cells.html">load_cells</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.calibration/olfactometer.html">olfactometer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.calibration/water_valve.html">water_valve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.calibration/treadmill.html">treadmill</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../json_schemas.html">JsonSchema</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of JsonSchema</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../json_schemas/aind_behavior_data_types.html">aind_behavior_data_types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json_schemas/aind_behavior_session.html">aind_behavior_session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json_schemas/aind_behavior_subject_database.html">aind_behavior_subject_database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json_schemas/aind_manipulator_calibration_logic.html">aind_manipulator_calibration_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json_schemas/aind_manipulator_calibration_rig.html">aind_manipulator_calibration_rig</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../data_formats.html">Data formats</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Data formats</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../core/conventions.html">Standard conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core/dataset_structure.html">Dataset structure</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Harp</a></li>
<li class="toctree-l2"><a class="reference internal" href="software_events.html">Software Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="video.html">Video</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/AllenNeuralDynamics/Aind.Behavior.Services">GitHub Source Code</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/articles/data_formats/harp.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="harp">
<h1>Harp<a class="headerlink" href="#harp" title="Link to this heading">¶</a></h1>
<section id="version">
<h2>Version<a class="headerlink" href="#version" title="Link to this heading">¶</a></h2>
<p>0.1.0-draft</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>While Harp data is largely used for behavior experiments, it is not limited to this modality. As a result, the current standard is scoped to the logging at the level of single Harp devices. The reason for this decision will hopefully become clear as we describe the format and some of the rationale behind it.</p>
<p>Most of the Harp-related concepts mentioned here will be expanded in the <a class="reference external" href="https://harp-tech.org/protocol/BinaryProtocol-8bit.html">documentation of the protocol</a>.</p>
<p>We will strictly follow the logging standards defined by <a class="reference external" href="https://harp-tech.org/articles/python.html#data-models">Harp</a>. This decision is justified by the following reasons:</p>
<ul class="simple">
<li><p>Affords the ability to not only use the same data format within our organization but also to share data with other groups that use Harp;</p></li>
<li><p>Affords the ability to reuse common <a class="reference external" href="https://pypi.org/project/harp-python/0.2.0/">data ingesting tools maintained by others</a>. Since it is an open-source community standard, we also have the ability to contribute to the development of these tools if we so wish;</p></li>
<li><p>Affords re-usability of data acquisition, QC and processing pipelines that can be centralized and validated by us and potentially used by others.</p></li>
</ul>
</section>
<section id="format-specification">
<h2>Format specification<a class="headerlink" href="#format-specification" title="Link to this heading">¶</a></h2>
<p>One of the main advantages of using a standardized binary communication protocol is that logging data from harp devices can be largely generalized. In theory, we could simply dump the binary data from the device into a single file and call it a day. However this is not always the most convenient way to log data. For instance, if one is interested in ingesting only a subset of messages (e.g. only the messages from a particular sensor or pin), then the previous approach would require a post-processing step to filter out the messages of interest.
Furthermore, each address, as per harp protocol spec, has potentially different data formats (e.g. <code class="docutils literal notranslate"><span class="pre">U8</span></code> vs <code class="docutils literal notranslate"><span class="pre">U16</span></code>) or even different lengths if array registers are involved. This can make it very tedious to parse and analyze a binary file offline, since we will have to examine the header of each and every message in the file to determine how to extract its contents.</p>
<p>This analysis could be entirely eliminated if we knew that all messages in the binary file had the same format. For any Harp device, the payload stored in a specific register will have a fixed type and length. This means that to ensure our simplifying assumption it is enough to save each message from a specific register into a different file (aka de-multiplexing strategy).</p>
<p>Thus, for each device, the container of all data will be a single directory with the extension <code class="docutils literal notranslate"><span class="pre">&lt;&gt;.harp</span></code>. This directory will contain the following files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>📦&lt;Device&gt;.harp
┣ 📜&lt;DeviceName&gt;_0.bin
┣ 📜&lt;DeviceName&gt;_1.bin
┣ ...
┣ 📜&lt;DeviceName&gt;_&lt;Reg&gt;.bin
┗ 📜device.yml (Optional)
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;DeviceName&gt;</span></code> will be derived from the <code class="docutils literal notranslate"><span class="pre">device.yml</span></code> metadata file that fully defines the device and can be found in the repository of each device (<a class="reference external" href="https://raw.githubusercontent.com/harp-tech/device.behavior/main/device.yml">e.g.</a>). This file can be seen as the “ground truth” specification of the device. It is used to automatically generate documentation, interfaces and data ingestion tools.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;Device&gt;</span></code> should match the name of the device in the <code class="docutils literal notranslate"><span class="pre">rig.json</span></code> schema file;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;Reg&gt;</span></code> is the register number that is logged in the binary file.</p></li>
</ul>
<section id="the-optional-device-yml-file">
<h3>The optional <code class="docutils literal notranslate"><span class="pre">device.yml</span></code> file<a class="headerlink" href="#the-optional-device-yml-file" title="Link to this heading">¶</a></h3>
<p>Including the <code class="docutils literal notranslate"><span class="pre">device.yml</span></code> file that corresponds to the device interface used to log the device’s data is recommended. Currently, this is not mandatory, but as ecosystem adoption progresses and tools improve, it will likely become a standard requirement. Note that while the <code class="docutils literal notranslate"><span class="pre">device.yml</span></code> file specifies the targeted hardware, firmware, and core versions, it does not guarantee that the device from which data was acquired is running those versions. This metadata should instead be queried directly from the corresponding device’s registers(<a class="reference external" href="https://harp-tech.org/protocol/Device.html#table---list-of-available-common-registers">see protocol core registers</a>)</p>
</section>
<section id="optional-logging-of-commands">
<h3>Optional logging of commands<a class="headerlink" href="#optional-logging-of-commands" title="Link to this heading">¶</a></h3>
<p>A critical aspect of using the Harp protocol is that for each <code class="docutils literal notranslate"><span class="pre">Write</span></code> message received by the device from the PC host, the client will echo back a Write message timestamped by the embedded device. This assumes that all messages issued by the host are received by the device and not lost in transmission. However, this is not guaranteed. In case of a lost message, the host will not receive the echo back and cannot confirm that the message was received by the device.</p>
<p>To perform post-hoc quality control, we recommend also logging <code class="docutils literal notranslate"><span class="pre">Commands</span></code>. Since <code class="docutils literal notranslate"><span class="pre">Commands</span></code> are also HarpMessage types, they can be logged in the same format as data from devices. We also recommend appending a software timestamp to each <code class="docutils literal notranslate"><span class="pre">Command</span></code> message to facilitate pairing requests with responses post-hoc.</p>
</section>
</section>
<section id="application-notes">
<h2>Application notes<a class="headerlink" href="#application-notes" title="Link to this heading">¶</a></h2>
<p>All harp devices, regardless of their specific application, are expected to be logged according to the following standards:</p>
<section id="clock-synchronization">
<h3>Clock Synchronization<a class="headerlink" href="#clock-synchronization" title="Link to this heading">¶</a></h3>
<p>We will only consider two operational modes for devices used in the AIND: <code class="docutils literal notranslate"><span class="pre">Standalone</span></code> and <code class="docutils literal notranslate"><span class="pre">Synchronized</span></code></p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">Standalone</span></code> mode the Harp device is not subordinate to a distributed clock, and all messages are timestamped by the device’s internal clock. This mode can be used if only a single Harp device is used during experiment acquisition.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">Synchronized</span></code> mode, the Harp device is subordinate to a distributed clock, and all messages are timestamped by the distributed clock. This mode should be used when multiple Harp devices are used during experiment acquisition. In each experiment, there shall be a single clock generator source (e.g. <a class="reference external" href="https://github.com/AllenNeuralDynamics/harp.device.white-rabbit">WhiteRabbit device</a>) to which all devices are connected. This source device is logged like any other Harp device.</p></li>
</ul>
</section>
<section id="interfacing-with-bonsai">
<h3>Interfacing with Bonsai<a class="headerlink" href="#interfacing-with-bonsai" title="Link to this heading">¶</a></h3>
<p>The following points will describe recommendations and recipes for logging data from harp devices using <a class="reference external" href="https://bonsai-rx.org/">Bonsai programming language</a>. We will assume a basic <a class="reference external" href="https://bonsai-rx.org/docs/">understanding of the Bonsai programming language</a>, and <a class="reference external" href="https://harp-tech.org/articles/intro.html">how to interface with Harp devices from it</a>.</p>
<p>Instructions on how to log data from a Harp device using Bonsai can be found in the <a class="reference external" href="https://harp-tech.org/articles/logging.html#groupbyregister">Harp Bonsai interface docs</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In your experiments, always validate that your logging routine has fully initialized before requesting a reading dump from the device. Failure to do so may result in missing data.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the future we will update these recipes to also provide AIND specific examples.</p>
</div>
<p>It is critical that the messages logged from the device are sufficient to reconstruct its state history. For that to be true, we need to know the initial state of all registers. This can be asked via a special register in the protocol core: <a class="reference external" href="https://harp-tech.org/protocol/Device.html#r_operation_ctrl-u16--operation-mode-configuration">OperationControl</a>. This register has a single bit that, when set, will trigger the device to send a dump all the values of all its registers.</p>
<ul class="simple">
<li><p>To the previous example, in a different branch:</p></li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">Timer</span></code> operator with its <code class="docutils literal notranslate"><span class="pre">DueTime</span></code> property set to 2 seconds. This will mimic the delayed start of an experiment.</p></li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">CreateMessage(Bonsai.Harp)</span></code> operator after the <code class="docutils literal notranslate"><span class="pre">Timer</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">OperationControlPayload</span></code> under <code class="docutils literal notranslate"><span class="pre">Payload</span></code>. Depending on your use case, you might want to change some of the settings, but we recommend:
- <code class="docutils literal notranslate"><span class="pre">DumpRegisters</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code> (Required for the dump)
- <code class="docutils literal notranslate"><span class="pre">Heartbeat</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code> (Useful to know the device is still alive)
- <code class="docutils literal notranslate"><span class="pre">MuteReplies</span></code> set to <code class="docutils literal notranslate"><span class="pre">False</span></code>
- <code class="docutils literal notranslate"><span class="pre">OperationLed</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code>
- <code class="docutils literal notranslate"><span class="pre">OperationMode</span></code> set to <code class="docutils literal notranslate"><span class="pre">Active</span></code>
- <code class="docutils literal notranslate"><span class="pre">VisualIndicator</span></code> set to <code class="docutils literal notranslate"><span class="pre">On</span></code></p></li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">Multicast</span></code> operator to send the message to the device</p></li>
</ul>
<details>
<summary><a>Bonsai example workflow</a></summary><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;WorkflowBuilder</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.8.1&quot;</span>
<span class="w">                </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="w">                </span><span class="na">xmlns:rx=</span><span class="s">&quot;clr-namespace:Bonsai.Reactive;assembly=Bonsai.Core&quot;</span>
<span class="w">                </span><span class="na">xmlns:harp=</span><span class="s">&quot;clr-namespace:Bonsai.Harp;assembly=Bonsai.Harp&quot;</span>
<span class="w">                </span><span class="na">xmlns=</span><span class="s">&quot;https://bonsai-rx.org/2018/workflow&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;Workflow&gt;</span>
<span class="w">    </span><span class="nt">&lt;Nodes&gt;</span>
<span class="w">    </span><span class="nt">&lt;Expression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;Combinator&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;Combinator</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;rx:Timer&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;rx:DueTime&gt;</span>PT2S<span class="nt">&lt;/rx:DueTime&gt;</span>
<span class="w">        </span><span class="nt">&lt;rx:Period&gt;</span>PT0S<span class="nt">&lt;/rx:Period&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Combinator&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Expression&gt;</span>
<span class="w">    </span><span class="nt">&lt;Expression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;harp:CreateMessage&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:MessageType&gt;</span>Write<span class="nt">&lt;/harp:MessageType&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:Payload</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;harp:CreateOperationControlPayload&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:OperationMode&gt;</span>Active<span class="nt">&lt;/harp:OperationMode&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:DumpRegisters&gt;</span>false<span class="nt">&lt;/harp:DumpRegisters&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:MuteReplies&gt;</span>false<span class="nt">&lt;/harp:MuteReplies&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:VisualIndicators&gt;</span>Off<span class="nt">&lt;/harp:VisualIndicators&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:OperationLed&gt;</span>Off<span class="nt">&lt;/harp:OperationLed&gt;</span>
<span class="w">        </span><span class="nt">&lt;harp:Heartbeat&gt;</span>Disabled<span class="nt">&lt;/harp:Heartbeat&gt;</span>
<span class="w">        </span><span class="nt">&lt;/harp:Payload&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Expression&gt;</span>
<span class="w">    </span><span class="nt">&lt;Expression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;MulticastSubject&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;Name&gt;</span>BehaviorCommands<span class="nt">&lt;/Name&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Expression&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Nodes&gt;</span>
<span class="w">    </span><span class="nt">&lt;Edges&gt;</span>
<span class="w">    </span><span class="nt">&lt;Edge</span><span class="w"> </span><span class="na">From=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Label=</span><span class="s">&quot;Source1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Edge</span><span class="w"> </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Label=</span><span class="s">&quot;Source1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Edges&gt;</span>
<span class="nt">&lt;/Workflow&gt;</span>
<span class="nt">&lt;/WorkflowBuilder&gt;</span>
</pre></div>
</div>
</details><p>Finally, commands to the device can be logged in the exact same way as replies. However, in order to facilitate post-hoc quality control, we recommend appending a software timestamp to each <code class="docutils literal notranslate"><span class="pre">Command</span></code> message. This can be done by <a class="reference external" href="https://harp-tech.org/articles/message-manipulation.html#injecting-or-modifying-message-timestamps">“injecting” a timestamp into the message payload</a> before logging. We recommend using high frequency events from a single device as a <a class="reference external" href="https://harp-tech.org/articles/message-manipulation.html#timestamping-generic-data">source of “the latest timestamp” to be used in the Command message</a>. We should stress that these timestamps should not be used for analysis that require precise and accurate synchronization, as they are not synchronized with the distributed clock.</p>
</section>
</section>
<section id="relationship-to-aind-data-schema">
<h2>Relationship to aind-data-schema<a class="headerlink" href="#relationship-to-aind-data-schema" title="Link to this heading">¶</a></h2>
<p>Most fields tracked in <code class="docutils literal notranslate"><span class="pre">rig.json</span></code> can be easily extracted from the device’s read-dump. It is likely that helper methods will be provided in the future to automate this conversion. For now, refer to the <a class="reference external" href="https://github.com/harp-tech/protocol/blob/main/Device.md#table---list-of-available-common-registers">protocol’s core registers</a> to extract the necessary information.</p>
</section>
<section id="file-quality-assurances">
<h2>File Quality Assurances<a class="headerlink" href="#file-quality-assurances" title="Link to this heading">¶</a></h2>
<p>By virtue of implementing the Harp communication and synchronization protocol the following should be true:</p>
<ul class="simple">
<li><p>Each data set should, at most, have a device as a source of the synchronized clock.</p></li>
<li><p>All messages from the device to the computer host should be logged. Once a message is successfully parsed, no more processing and/or filtering of the data stream will be done prior to logging.</p></li>
<li><p>All data from a single device will include the initial state of all registers. This can be achieved by setting the <code class="docutils literal notranslate"><span class="pre">DumpRegisters</span></code> bit in the <code class="docutils literal notranslate"><span class="pre">OperationControl</span></code> register. Given that this is true, inside the container folder, one file per register of the device is expected to be found with a minimum of one message in each file.</p></li>
<li><p>If Commands are logged, for each message sent to the device, a corresponding message should exist in the logged data from the harp device. The type of the message in the Command will match the type of the reply from the device.</p></li>
<li><p>If multiple devices are used, all data is assumed to be synchronized at acquisition time.</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="software_events.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Software Events</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../core/dataset_structure.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Dataset structure</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Harp</a><ul>
<li><a class="reference internal" href="#version">Version</a></li>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#format-specification">Format specification</a><ul>
<li><a class="reference internal" href="#the-optional-device-yml-file">The optional <code class="docutils literal notranslate"><span class="pre">device.yml</span></code> file</a></li>
<li><a class="reference internal" href="#optional-logging-of-commands">Optional logging of commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#application-notes">Application notes</a><ul>
<li><a class="reference internal" href="#clock-synchronization">Clock Synchronization</a></li>
<li><a class="reference internal" href="#interfacing-with-bonsai">Interfacing with Bonsai</a></li>
</ul>
</li>
<li><a class="reference internal" href="#relationship-to-aind-data-schema">Relationship to aind-data-schema</a></li>
<li><a class="reference internal" href="#file-quality-assurances">File Quality Assurances</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=11e62b30"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>